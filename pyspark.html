<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PySpark Internals Simulator</title>
    <style>
        :root {
            /* Cyberpunk Theme */
            --bg-dark: #050505;
            --bg-panel: #0f1115;
            --border: #27272a;
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-purple: #bc13fe;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --font-code: 'Menlo', 'Monaco', monospace;
            --font-ui: 'Inter', system-ui, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none; /* Prevent text selection */
        }

        /* HEADER */
        header {
            height: 60px;
            background: rgba(15, 17, 21, 0.9);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 100;
        }

        .brand {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--neon-blue);
            display: flex;
            align-items: center;
            gap: 15px;
            letter-spacing: 1px;
        }

        .home-btn {
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .home-btn:hover {
            border-color: var(--neon-purple);
            color: var(--neon-purple);
            background: rgba(188, 19, 254, 0.1);
        }

        /* LAYOUT */
        .grid-container {
            display: grid;
            grid-template-columns: 320px 450px 1fr;
            flex: 1;
            height: calc(100vh - 60px);
        }

        .panel {
            border-right: 1px solid var(--border);
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 12px 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
        }

        /* CONTROLS */
        .controls-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        select {
            width: 100%; background: var(--bg-panel); color: var(--text-main);
            border: 1px solid var(--border); padding: 10px; border-radius: 4px;
            outline: none; cursor: pointer;
        }
        
        .toggle-switch { display: flex; gap: 10px; }
        .toggle-btn {
            flex: 1; background: transparent; border: 1px solid var(--border);
            color: var(--text-muted); padding: 8px; border-radius: 4px; cursor: pointer;
        }
        .active-bad { border-color: var(--neon-pink); color: var(--neon-pink); background: rgba(255,0,85,0.1); }
        .active-good { border-color: var(--neon-green); color: var(--neon-green); background: rgba(0,255,157,0.1); }

        .btn-run {
            width: 100%; padding: 12px; background: var(--neon-blue); color: #000;
            border: none; border-radius: 4px; font-weight: 800; cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }
        .btn-run:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

        .log-box { flex: 1; background: #000; border: 1px solid var(--border); padding: 10px; font-family: var(--font-code); font-size: 0.8rem; overflow-y: auto; color: var(--text-muted); }
        .log-entry { margin-bottom: 5px; border-left: 2px solid #333; padding-left: 8px; }

        /* CODE & CLUSTER */
        .code-window { flex: 1; background: #0b0d10; padding: 20px; overflow: auto; font-family: var(--font-code); font-size: 0.85rem; line-height: 1.6; color: #a6accd; }
        .plan-window { height: 35%; background: var(--bg-panel); padding: 15px; overflow-y: auto; }
        
        .cluster-stage { flex: 1; background: radial-gradient(circle at 50% 50%, #111 1px, transparent 1px); background-size: 20px 20px; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .driver-node { align-self: center; width: 150px; padding: 10px; border: 2px solid var(--neon-purple); text-align: center; border-radius: 6px; color: var(--neon-purple); font-weight: bold; }
        .executor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; }
        .executor { background: var(--bg-panel); border: 1px solid var(--border); padding: 10px; border-radius: 6px; display: flex; flex-direction: column; transition: 0.3s; }
        .executor.crashed { border-color: var(--neon-pink); opacity: 0.6; }
        
        /* DATA BLOCKS */
        .data-pool { flex: 1; border: 1px dashed #333; margin-top: 10px; padding: 5px; display: flex; flex-wrap: wrap; gap: 5px; }
        .block { width: 25px; height: 25px; background: var(--neon-blue); border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #000; font-weight: bold; animation: pop 0.3s; }
        .block.skew { width: 80px; background: var(--neon-pink); color: white; }
        .block.salt { background: var(--neon-green); color: black; border: 1px solid white; }
        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }

        /* SYNTAX HIGHLIGHT */
        .com { color: #676e95; font-style: italic; }
        .bad-hl { background: rgba(255, 0, 85, 0.1); border-left: 3px solid var(--neon-pink); padding-left: 5px; display: block; }
        .good-hl { background: rgba(0, 255, 157, 0.1); border-left: 3px solid var(--neon-green); padding-left: 5px; display: block; }

    </style>
</head>
<body oncontextmenu="return false;">

    <header>
        <div class="brand">
            <a href="index.html" class="home-btn">üè† Home</a>
            <span>‚ö° PYSPARK SIMULATOR</span>
        </div>
        <a href="#" onclick="alert('Select a scenario on the left to start.')" class="home-btn">Help ?</a>
    </header>

    <div class="grid-container">
        <!-- LEFT -->
        <div class="panel">
            <div class="panel-header">Configuration</div>
            <div class="controls-body">
                <label>SCENARIO</label>
                <select id="scenarioSelect" onchange="initScenario()">
                    <option value="skew">Data Skew (OOM)</option>
                    <option value="wide">Wide vs Narrow</option>
                    <option value="broadcast">Broadcast Join</option>
                    <option value="execoom">Explode (Executor OOM)</option>
                </select>

                <div class="toggle-switch">
                    <button id="btnBad" class="toggle-btn active-bad" onclick="setMode('bad')">PROBLEM</button>
                    <button id="btnGood" class="toggle-btn" onclick="setMode('good')">FIXED</button>
                </div>

                <button id="runBtn" class="btn-run" onclick="nextStep()">Start</button>
                
                <div class="log-box" id="logger">Ready.</div>
            </div>
        </div>

        <!-- CENTER -->
        <div class="panel">
            <div class="panel-header">Code & Plan</div>
            <div class="code-window" id="codeView"></div>
            <div class="panel-header">DAG Visualization</div>
            <div class="plan-window" id="dagView" style="color:var(--text-muted); font-size:0.8rem; padding:20px; text-align:center;">
                DAG Nodes will appear here...
            </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
            <div class="panel-header">Cluster State</div>
            <div class="cluster-stage">
                <div class="driver-node" id="driver">DRIVER</div>
                <div class="executor-grid">
                    <script>
                        for(let i=0; i<4; i++) {
                            document.write(`<div class="executor" id="ex${i}">
                                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888;">
                                    <span>Exec ${i+1}</span><span>RAM <span id="ram-${i}">0%</span></span>
                                </div>
                                <div style="height:4px; background:#333; margin-top:5px;"><div id="bar-${i}" style="height:100%; width:0%; background:var(--neon-blue); transition:0.3s;"></div></div>
                                <div class="data-pool" id="stage-${i}"></div>
                            </div>`);
                        }
                    </script>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Security: Block Shortcuts
        document.onkeydown = function(e) {
            if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73) || (e.ctrlKey && e.keyCode == 85)) return false;
        }

        const scenarios = {
            skew: {
                bad: { 
                    code: `<span class="com"># ‚ùå Skewed Join</span>\ndf1.join(df2, "user_id")\n<span class="bad-hl"># 90% NULL keys go to Ex 1</span>`,
                    steps: [{msg:"Reading...", action:"spawn_skew"}, {msg:"Shuffle (Hashing)...", type:"info"}, {msg:"Ex 1 Overloaded", action:"load_bad"}, {msg:"OOM Crash!", action:"crash"}]
                },
                good: { 
                    code: `<span class="com"># ‚úÖ Salting Fix</span>\ndf.withColumn("salt", rand())\n<span class="good-hl">df.join(df2, concat("id", "salt"))</span>`,
                    steps: [{msg:"Generating Salts...", action:"spawn_salt"}, {msg:"Shuffling...", action:"shuffle_good"}, {msg:"Balanced Load", action:"load_good"}, {msg:"Success", type:"success"}]
                }
            },
            wide: {
                bad: { code: `df.groupBy().count() <span class="bad-hl"># Full Shuffle</span>`, steps: [{action:"spawn_balanced"}, {msg:"Shuffling ALL data...", action:"shuffle_heavy"}, {msg:"Network Lag", action:"load_heavy"}] },
                good: { code: `df.reduceByKey() <span class="good-hl"># Map-Side Combine</span>`, steps: [{action:"spawn_balanced"}, {msg:"Local Combine...", action:"load_good"}, {msg:"Shuffle Sums only", action:"shuffle_good"}] }
            },
            broadcast: {
                bad: { code: `big.join(small) <span class="bad-hl"># SortMergeJoin</span>`, steps: [{action:"spawn_balanced"}, {msg:"Shuffling TBs...", action:"shuffle_heavy"}] },
                good: { code: `big.join(broadcast(small))`, steps: [{msg:"Broadcasting...", action:"broadcast"}, {msg:"Local Join", action:"load_good"}] }
            },
            execoom: {
                bad: { code: `df.select(explode()) <span class="bad-hl"># Single Partition</span>`, steps: [{action:"spawn_skew"}, {msg:"Exploding...", action:"explode_bad"}, {msg:"OOM", action:"crash"}] },
                good: { code: `df.repartition(100).explode()`, steps: [{action:"spawn_salt"}, {msg:"Exploding...", action:"explode_good"}, {msg:"Success", type:"success"}] }
            }
        };

        let currentKey = 'skew', currentMode = 'bad', stepIdx = 0;

        function initScenario() {
            currentKey = document.getElementById('scenarioSelect').value;
            setMode('bad');
        }

        function setMode(mode) {
            currentMode = mode; stepIdx = 0;
            document.getElementById('btnBad').className = `toggle-btn ${mode=='bad'?'active-bad':''}`;
            document.getElementById('btnGood').className = `toggle-btn ${mode=='good'?'active-good':''}`;
            document.getElementById('codeView').innerHTML = `<pre>${scenarios[currentKey][mode].code}</pre>`;
            document.getElementById('logger').innerText = "Ready.";
            document.getElementById('runBtn').disabled = false;
            document.getElementById('runBtn').innerText = "Next Step";
            resetCluster();
        }

        function nextStep() {
            const steps = scenarios[currentKey][currentMode].steps;
            if (stepIdx >= steps.length) return;
            const s = steps[stepIdx];
            
            const log = document.createElement('div');
            log.className = 'log-entry';
            log.style.borderLeftColor = s.type === 'success' ? 'var(--neon-green)' : 'var(--neon-blue)';
            log.innerText = "> " + s.msg;
            document.getElementById('logger').appendChild(log);

            if(s.action) runVisual(s.action);
            
            stepIdx++;
            if(stepIdx >= steps.length) {
                document.getElementById('runBtn').innerText = "Done";
                document.getElementById('runBtn').disabled = true;
            }
        }

        function resetCluster() {
            for(let i=0; i<4; i++) {
                document.getElementById(`stage-${i}`).innerHTML = '';
                document.getElementById(`ex${i}`).className = 'executor';
                updateRes(i, 0);
            }
        }

        function updateRes(id, val, color) {
            const bar = document.getElementById(`bar-${id}`);
            bar.style.width = val + "%";
            bar.style.background = color || 'var(--neon-blue)';
            document.getElementById(`ram-${id}`).innerText = val + "%";
        }

        function runVisual(act) {
            switch(act) {
                case 'spawn_skew': 
                    document.getElementById('stage-0').innerHTML += `<div class="block skew">NULL</div>`;
                    [1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block">ID</div>`);
                    break;
                case 'load_bad': updateRes(0, 100, 'var(--neon-pink)'); break;
                case 'crash': document.getElementById('ex0').classList.add('crashed'); break;
                case 'spawn_salt': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block salt">Key</div>`); break;
                case 'shuffle_good': 
                    for(let i=0; i<4; i++) { document.getElementById(`stage-${i}`).innerHTML = ''; }
                    setTimeout(() => [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block salt">Key</div>`), 300);
                    break;
                case 'load_good': [0,1,2,3].forEach(i => updateRes(i, 40, 'var(--neon-green)')); break;
                case 'spawn_balanced': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block">Data</div>`); break;
                case 'shuffle_heavy': [0,1,2,3].forEach(i => { document.getElementById(`stage-${i}`).innerHTML = ''; setTimeout(()=>document.getElementById(`stage-${i}`).innerHTML += `<div class="block">...</div>`, i*100)}); break;
                case 'load_heavy': [0,1,2,3].forEach(i => updateRes(i, 80, 'orange')); break;
                case 'broadcast': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block salt">BC</div>`); break;
                case 'explode_bad': for(let k=0; k<10; k++) setTimeout(()=>document.getElementById('stage-0').innerHTML+=`<div class="block tiny">.</div>`, k*50); break;
                case 'explode_good': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block tiny">..</div>`); break;
            }
        }

        initScenario();
    </script>
</body>
</html>