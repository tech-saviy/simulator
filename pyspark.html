<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PySpark Internals Simulator</title>
    <style>
        :root {
            /* Cyberpunk Palette */
            --bg-dark: #050505;
            --bg-panel: #0f1115;
            --border: #27272a;
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-purple: #bc13fe;
            --neon-orange: #ff9d00;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --font-code: 'Menlo', 'Monaco', monospace;
            --font-ui: 'Inter', system-ui, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* HEADER */
        header {
            height: 60px;
            background: rgba(15, 17, 21, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 100;
        }

        .brand {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--neon-blue);
            display: flex;
            align-items: center;
            gap: 15px;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        .home-btn {
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .home-btn:hover {
            border-color: var(--neon-purple);
            color: var(--neon-purple);
            background: rgba(188, 19, 254, 0.1);
            box-shadow: 0 0 15px rgba(188, 19, 254, 0.2);
        }

        /* GRID LAYOUT */
        .grid-container {
            display: grid;
            grid-template-columns: 340px 480px 1fr;
            flex: 1;
            height: calc(100vh - 60px);
        }

        .panel {
            border-right: 1px solid var(--border);
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 12px 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* CONTROLS */
        .controls-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        
        select {
            width: 100%; background: var(--bg-panel); color: var(--text-main);
            border: 1px solid var(--border); padding: 12px; border-radius: 6px;
            outline: none; cursor: pointer; font-family: var(--font-ui);
        }
        select:hover { border-color: var(--neon-blue); }
        optgroup { color: var(--neon-purple); font-weight: bold; }

        .toggle-switch { display: flex; gap: 10px; background: #111; padding: 4px; border-radius: 6px; border: 1px solid var(--border); }
        .toggle-btn {
            flex: 1; background: transparent; border: none;
            color: var(--text-muted); padding: 8px; border-radius: 4px; cursor: pointer; font-weight: 600;
            transition: 0.3s;
        }
        .active-bad { background: rgba(255, 0, 85, 0.15); color: var(--neon-pink); text-shadow: 0 0 5px rgba(255,0,85,0.5); }
        .active-good { background: rgba(0, 255, 157, 0.15); color: var(--neon-green); text-shadow: 0 0 5px rgba(0,255,157,0.5); }

        .btn-run {
            width: 100%; padding: 14px; background: var(--neon-blue); color: #000;
            border: none; border-radius: 6px; font-weight: 800; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s;
        }
        .btn-run:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 30px rgba(0, 243, 255, 0.4); }
        .btn-run:disabled { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }

        .log-box { 
            flex: 1; background: #080a0c; border: 1px solid var(--border); padding: 12px; 
            font-family: var(--font-code); font-size: 0.8rem; overflow-y: auto; color: var(--text-muted); 
            border-radius: 6px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .log-entry { margin-bottom: 8px; border-left: 3px solid #333; padding-left: 10px; line-height: 1.4; animation: fadeIn 0.3s; }
        .log-entry.info { border-color: var(--neon-blue); color: #fff; }
        .log-entry.error { border-color: var(--neon-pink); color: var(--neon-pink); }
        .log-entry.success { border-color: var(--neon-green); color: var(--neon-green); }

        /* CENTER PANEL */
        .code-window { flex: 1; background: #080a0c; padding: 20px; overflow: auto; font-family: var(--font-code); font-size: 0.85rem; line-height: 1.6; color: #a6accd; border-bottom: 1px solid var(--border); }
        .plan-window { height: 30%; background: var(--bg-panel); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        
        .dag-node {
            background: #1a1d24; border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px;
            font-size: 0.75rem; color: var(--text-muted); min-width: 150px; text-align: center; position: relative;
        }
        .dag-node::after { content: '‚Üì'; position: absolute; bottom: -18px; left: 50%; color: #333; font-size: 14px; transform: translateX(-50%); }
        .dag-node:last-child::after { content: ''; }
        .dag-node.active { border-color: var(--neon-blue); color: #fff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }

        /* CLUSTER VISUALS */
        .cluster-stage { 
            flex: 1; background: radial-gradient(circle at 50% 50%, #111 1px, transparent 1px); 
            background-size: 30px 30px; padding: 30px; display: flex; flex-direction: column; gap: 30px; 
        }
        
        .driver-node { 
            align-self: center; width: 200px; padding: 15px; border: 2px solid var(--neon-purple); 
            text-align: center; border-radius: 8px; color: var(--neon-purple); font-weight: 800;
            background: rgba(188, 19, 254, 0.05); transition: 0.3s;
        }
        .driver-node.crash { background: var(--neon-pink); color: #000; border-color: var(--neon-pink); box-shadow: 0 0 30px var(--neon-pink); animation: shake 0.5s; }

        .executor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; }
        .executor { 
            background: var(--bg-panel); border: 1px solid var(--border); padding: 15px; 
            border-radius: 8px; display: flex; flex-direction: column; transition: 0.3s; position: relative;
        }
        .executor.crashed { border-color: var(--neon-pink); opacity: 0.5; filter: grayscale(1); }
        .executor.crashed::after { content: 'OOM'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); color: var(--neon-pink); font-weight: 900; font-size: 2rem; border: 3px solid var(--neon-pink); padding: 5px 15px; }

        .res-bar-container { height: 6px; background: #222; margin-top: 5px; border-radius: 3px; overflow: hidden; }
        .res-bar { height: 100%; width: 0%; background: var(--neon-blue); transition: 0.4s ease-out; }

        /* DATA BLOCKS */
        .data-pool { flex: 1; border: 1px dashed #333; margin-top: 15px; padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 6px; position: relative; }
        .block { 
            width: 30px; height: 30px; background: var(--neon-blue); border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; font-size: 0.6rem; 
            color: #000; font-weight: 800; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transition: all 0.5s;
        }
        .block.skew { width: 90px; background: var(--neon-pink); color: white; }
        .block.salt { background: var(--neon-green); border: 1px solid #fff; }
        .block.cached { border: 2px solid var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .block.tiny { width: 15px; height: 15px; font-size: 0; }
        .block.slow { animation: pulseSlow 1s infinite; background: var(--neon-orange); }

        /* CODE HIGHLIGHTING */
        .com { color: #676e95; font-style: italic; }
        .bad-hl { background: rgba(255, 0, 85, 0.1); border-left: 3px solid var(--neon-pink); padding-left: 10px; display: block; }
        .good-hl { background: rgba(0, 255, 157, 0.1); border-left: 3px solid var(--neon-green); padding-left: 10px; display: block; }

        /* ANIMATIONS */
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes pulseSlow { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

    </style>
</head>
<body oncontextmenu="return false;">

    <header>
        <div class="brand">
            <a href="index.html" class="home-btn">üè† Home</a>
            <span>‚ö° PYSPARK ADVANCED SIMULATOR</span>
        </div>
        <a href="#" onclick="alert('Step-by-step visualization of Spark internals. Select a scenario to begin.')" class="home-btn">Help ?</a>
    </header>

    <div class="grid-container">
        <!-- LEFT PANEL -->
        <div class="panel">
            <div class="panel-header">Configuration</div>
            <div class="controls-body">
                <label>SELECT SCENARIO</label>
                <select id="scenarioSelect" onchange="initScenario()">
                    <optgroup label="Core Concepts">
                        <option value="lazy">Lazy Evaluation vs Action</option>
                        <option value="wide">Wide (Shuffle) vs Narrow</option>
                    </optgroup>
                    <optgroup label="Common Issues">
                        <option value="skew">Data Skew (Join OOM)</option>
                        <option value="execoom">Executor OOM (Explode)</option>
                        <option value="driveroom">Driver OOM (Collect)</option>
                    </optgroup>
                    <optgroup label="Optimization">
                        <option value="broadcast">Broadcast Join</option>
                        <option value="cache">Caching & Persistence</option>
                        <option value="udf">Python UDF vs Pandas UDF</option>
                    </optgroup>
                </select>

                <div class="toggle-switch">
                    <button id="btnBad" class="toggle-btn active-bad" onclick="setMode('bad')">PROBLEM</button>
                    <button id="btnGood" class="toggle-btn" onclick="setMode('good')">OPTIMIZED</button>
                </div>

                <button id="runBtn" class="btn-run" onclick="nextStep()">Start Simulation</button>
                
                <div class="log-box" id="logger">
                    <div class="log-entry">System Initialized. Select a scenario.</div>
                </div>
            </div>
        </div>

        <!-- CENTER PANEL -->
        <div class="panel">
            <div class="panel-header">PySpark Code</div>
            <div class="code-window" id="codeView"></div>
            <div class="panel-header">DAG / Execution Plan</div>
            <div class="plan-window" id="dagView">
                <!-- DAG Nodes injected here -->
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="panel">
            <div class="panel-header">Cluster Backend</div>
            <div class="cluster-stage">
                <div class="driver-node" id="driver">DRIVER (JVM)</div>
                <div class="executor-grid">
                    <script>
                        for(let i=0; i<4; i++) {
                            document.write(`
                                <div class="executor" id="ex${i}">
                                    <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888; font-weight:bold;">
                                        <span>EXECUTOR ${i+1}</span>
                                        <span>RAM <span id="ram-txt-${i}">0%</span></span>
                                    </div>
                                    <div class="res-bar-container"><div id="bar-${i}" class="res-bar"></div></div>
                                    <div style="font-size:0.6rem; color:#666; margin-top:3px;">CPU: <span id="cpu-txt-${i}">Idle</span></div>
                                    <div class="data-pool" id="stage-${i}"></div>
                                </div>
                            `);
                        }
                    </script>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Disable Developer Shortcuts
        document.onkeydown = function(e) {
            if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73) || (e.ctrlKey && e.keyCode == 85)) return false;
        }

        /* --- SCENARIO DATA --- */
        const scenarios = {
            skew: {
                bad: { 
                    code: `<span class="com"># ‚ùå Problem: Data Skew</span>\ndf1 = spark.read.parquet("txns")\n<span class="bad-hl">joined = df1.join(users, "user_id")</span>\n<span class="com"># "NULL" keys (90% of data) hash to Ex 1</span>`,
                    plan: ["Scan Parquet", "Exchange (Hash)", "SortMergeJoin"],
                    steps: [
                        {msg:"Reading Data Partitions...", action:"spawn_skew"}, 
                        {msg:"Shuffle: Hashing Key 'NULL'...", type:"info"}, 
                        {msg:"All 'NULL' keys sent to Executor 1", action:"shuffle_skew_bad"}, 
                        {msg:"Executor 1 CPU/RAM Spike", action:"load_bad_skew"}, 
                        {msg:"OOM Error: Executor Crashed", action:"crash_ex0", type:"error"}
                    ]
                },
                good: { 
                    code: `<span class="com"># ‚úÖ Fix: Salting</span>\n<span class="good-hl">df1 = df1.withColumn("salt", rand())</span>\ndf1 = df1.join(users, concat("id", "salt"))\n<span class="com"># Keys split: NULL_0, NULL_1...</span>`,
                    plan: ["Scan", "Project (Salt)", "Exchange (Salted)", "SortMergeJoin"],
                    steps: [
                        {msg:"Generating Salted Keys...", action:"spawn_salt"}, 
                        {msg:"Shuffle: Distributing Salted Keys", action:"shuffle_good"}, 
                        {msg:"Load Balanced across Cluster", action:"load_balanced"}, 
                        {msg:"Job Completed Successfully", type:"success"}
                    ]
                }
            },
            execoom: {
                bad: { 
                    code: `<span class="com"># ‚ùå Problem: Explode on Big Partition</span>\ndf = spark.read.json("nested_data")\n<span class="bad-hl">df.select(explode("items"))</span>\n<span class="com"># Ex 1 creates 10M rows in RAM</span>`,
                    plan: ["Scan", "Generate (Explode)", "Project"],
                    steps: [
                        {msg:"Reading Nested Data...", action:"spawn_skew"}, 
                        {msg:"Exploding Arrays (Row multiplication)...", action:"explode_bad"}, 
                        {msg:"GC Overhead Limit Exceeded", action:"crash_ex0", type:"error"}
                    ]
                },
                good: { 
                    code: `<span class="com"># ‚úÖ Fix: Repartition First</span>\ndf = spark.read.json("nested_data")\n<span class="good-hl">df.repartition(100).explode("items")</span>\n<span class="com"># Spread load before exploding</span>`,
                    plan: ["Scan", "Exchange (RoundRobin)", "Generate (Explode)"],
                    steps: [
                        {msg:"Repartitioning Data...", action:"shuffle_salt"}, 
                        {msg:"Exploding in Parallel", action:"explode_good"}, 
                        {msg:"Success: 100M Rows Processed", type:"success"}
                    ]
                }
            },
            driveroom: {
                bad: {
                    code: `<span class="com"># ‚ùå Problem: Collect Big Data</span>\ndf = spark.read.parquet("big_data")\n<span class="bad-hl">result = df.collect()</span>\n<span class="com"># Sends ALL data to Driver RAM</span>`,
                    plan: ["Scan", "CollectLimit"],
                    steps: [
                        {msg:"Executors reading data...", action:"spawn_balanced"},
                        {msg:"Sending 100GB to Driver...", action:"send_to_driver"},
                        {msg:"Driver Heap Space Error!", action:"crash_driver", type:"error"}
                    ]
                },
                good: {
                    code: `<span class="com"># ‚úÖ Fix: Limit or Write</span>\ndf = spark.read.parquet("big_data")\n<span class="good-hl">result = df.limit(10).collect()</span>\n<span class="com"># Only top 10 rows sent</span>`,
                    plan: ["Scan", "Limit", "Collect"],
                    steps: [
                        {msg:"Executors reading...", action:"spawn_balanced"},
                        {msg:"Sending 10 rows to Driver", action:"send_safe_driver"},
                        {msg:"Success", type:"success"}
                    ]
                }
            },
            cache: {
                bad: {
                    code: `<span class="com"># ‚ùå Problem: Recomputing</span>\ndf = spark.read.csv("huge_file")\n<span class="bad-hl">df.count()  # Reads from Disk</span>\n<span class="bad-hl">df.count()  # Reads from Disk AGAIN</span>`,
                    plan: ["Scan CSV", "HashAggregate", "Exchange"],
                    steps: [
                        {msg:"Action 1: Reading CSV from Disk (Slow)...", action:"read_slow"},
                        {msg:"Action 1 Complete.", type:"info"},
                        {msg:"Action 2: Reading CSV from Disk AGAIN...", action:"read_slow"},
                        {msg:"Inefficient I/O.", type:"error"}
                    ]
                },
                good: {
                    code: `<span class="com"># ‚úÖ Fix: Caching</span>\ndf = spark.read.csv("huge_file")\n<span class="good-hl">df.cache()</span>\ndf.count() # Caches in RAM\ndf.count() # Reads from RAM`,
                    plan: ["Scan CSV", "InMemoryTableScan", "HashAggregate"],
                    steps: [
                        {msg:"Action 1: Reading & Caching...", action:"read_cache"},
                        {msg:"Blocks stored in Executor RAM", type:"success"},
                        {msg:"Action 2: Reading from RAM (Instant)", action:"read_ram"},
                        {msg:"Lightning Fast.", type:"success"}
                    ]
                }
            },
            udf: {
                bad: {
                    code: `<span class="com"># ‚ùå Problem: Python UDF</span>\n@udf("int")\ndef double(x): return x * 2\n<span class="bad-hl">df.select(double("val"))</span>\n<span class="com"># Row-by-row Serialization (Slow)</span>`,
                    plan: ["BatchEvalPython", "Project"],
                    steps: [
                        {msg:"Spawning Tasks...", action:"spawn_balanced"},
                        {msg:"Serializing Rows to Python (Pickle)...", action:"proc_slow"},
                        {msg:"High CPU Overhead / Slowness", action:"load_heavy_cpu"}
                    ]
                },
                good: {
                    code: `<span class="com"># ‚úÖ Fix: Pandas UDF (Arrow)</span>\n@pandas_udf("int")\ndef double(x): return x * 2\n<span class="good-hl">df.select(double("val"))</span>\n<span class="com"># Vectorized Batch (Fast)</span>`,
                    plan: ["ArrowEvalPython", "Project"],
                    steps: [
                        {msg:"Spawning Tasks...", action:"spawn_balanced"},
                        {msg:"Sending Batches (Apache Arrow)...", action:"proc_fast"},
                        {msg:"Vectorized Execution", type:"success"}
                    ]
                }
            },
            // Keeping previous basic scenarios
            wide: { bad: { code: `df.groupBy().count()`, plan: ["Exchange (Shuffle)"], steps: [{action:"spawn_balanced"}, {msg:"Shuffling ALL data...", action:"shuffle_heavy"}, {msg:"Network Congestion", action:"load_heavy"}] }, good: { code: `df.reduceByKey()`, plan: ["LocalLimit", "Exchange"], steps: [{action:"spawn_balanced"}, {msg:"Local Combine", action:"load_balanced"}, {msg:"Shuffle Sums", action:"shuffle_good"}] } },
            broadcast: { bad: { code: `big.join(small)`, plan: ["SortMergeJoin"], steps: [{action:"spawn_balanced"}, {msg:"Shuffling TBs...", action:"shuffle_heavy"}] }, good: { code: `big.join(broadcast(small))`, plan: ["BroadcastHashJoin"], steps: [{msg:"Broadcasting...", action:"broadcast"}, {msg:"Local Join", action:"load_balanced"}] } },
            lazy: { bad: { code: `df.filter(x > 10)`, plan: ["Logical Plan"], steps: [{msg:"No Action. No Job.", type:"info"}] }, good: { code: `df.count()`, plan: ["Job -> Stage -> Task"], steps: [{msg:"Action Triggered", action:"spawn_balanced"}] } }
        };

        let currentKey = 'skew', currentMode = 'bad', stepIdx = 0;

        function initScenario() {
            currentKey = document.getElementById('scenarioSelect').value;
            setMode('bad');
        }

        function setMode(mode) {
            currentMode = mode; stepIdx = 0;
            document.getElementById('btnBad').className = `toggle-btn ${mode=='bad'?'active-bad':''}`;
            document.getElementById('btnGood').className = `toggle-btn ${mode=='good'?'active-good':''}`;
            document.getElementById('codeView').innerHTML = `<pre>${scenarios[currentKey][mode].code}</pre>`;
            
            // Update DAG
            const dag = document.getElementById('dagView');
            dag.innerHTML = '';
            scenarios[currentKey][mode].plan.forEach(node => {
                dag.innerHTML += `<div class="dag-node">${node}</div>`;
            });

            document.getElementById('logger').innerHTML = '<div class="log-entry">Ready.</div>';
            document.getElementById('runBtn').disabled = false;
            document.getElementById('runBtn').innerText = "Next Step";
            resetCluster();
        }

        function nextStep() {
            const steps = scenarios[currentKey][currentMode].steps;
            if (stepIdx >= steps.length) return;
            const s = steps[stepIdx];
            
            const log = document.createElement('div');
            log.className = `log-entry ${s.type || ''}`;
            log.innerText = "> " + s.msg;
            document.getElementById('logger').appendChild(log);
            document.getElementById('logger').scrollTop = document.getElementById('logger').scrollHeight;

            // Highlight DAG
            const nodes = document.querySelectorAll('.dag-node');
            if(nodes[stepIdx]) nodes[stepIdx].classList.add('active');

            if(s.action) runVisual(s.action);
            
            stepIdx++;
            if(stepIdx >= steps.length) {
                document.getElementById('runBtn').innerText = "Done";
                document.getElementById('runBtn').disabled = true;
            }
        }

        function resetCluster() {
            for(let i=0; i<4; i++) {
                document.getElementById(`stage-${i}`).innerHTML = '';
                document.getElementById(`ex${i}`).className = 'executor';
                updateRes(i, 0, 0);
            }
            document.getElementById('driver').className = 'driver-node';
            document.getElementById('driver').innerText = "DRIVER (JVM)";
        }

        function updateRes(id, ram, cpu, color) {
            const bar = document.getElementById(`bar-${id}`);
            bar.style.width = ram + "%";
            bar.style.background = color || 'var(--neon-blue)';
            document.getElementById(`ram-txt-${id}`).innerText = ram + "%";
            if(cpu) document.getElementById(`cpu-txt-${id}`).innerText = cpu + "%";
        }

        function runVisual(act) {
            switch(act) {
                // SKEW / OOM
                case 'spawn_skew': 
                    document.getElementById('stage-0').innerHTML += `<div class="block skew">NULL</div>`;
                    [1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block">ID</div>`);
                    break;
                case 'load_bad_skew': updateRes(0, 100, 100, 'var(--neon-pink)'); break;
                case 'crash_ex0': document.getElementById('ex0').classList.add('crashed'); break;
                
                // SALTING
                case 'spawn_salt': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block salt">Key</div>`); break;
                case 'shuffle_good': 
                    for(let i=0; i<4; i++) { document.getElementById(`stage-${i}`).innerHTML = ''; }
                    setTimeout(() => [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block salt">Key</div>`), 300);
                    break;
                case 'load_balanced': [0,1,2,3].forEach(i => updateRes(i, 40, 30, 'var(--neon-green)')); break;
                
                // STANDARD
                case 'spawn_balanced': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block">Part</div>`); break;
                case 'shuffle_heavy': [0,1,2,3].forEach(i => { document.getElementById(`stage-${i}`).innerHTML = ''; setTimeout(()=>document.getElementById(`stage-${i}`).innerHTML += `<div class="block">...</div>`, i*100)}); break;
                case 'load_heavy': [0,1,2,3].forEach(i => updateRes(i, 80, 80, 'var(--neon-orange)')); break;
                case 'broadcast': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block salt">BC</div>`); break;
                
                // EXPLODE
                case 'explode_bad': for(let k=0; k<10; k++) setTimeout(()=>document.getElementById('stage-0').innerHTML+=`<div class="block tiny">.</div>`, k*50); break;
                case 'explode_good': [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML += `<div class="block tiny">..</div>`); break;

                // DRIVER OOM
                case 'send_to_driver':
                    for(let i=0; i<4; i++) {
                        document.getElementById(`stage-${i}`).innerHTML = ''; 
                        updateRes(i, 0, 0); // Clear execs
                        // Animate blocks flying to driver? simplified:
                    }
                    document.getElementById('driver').style.background = "var(--neon-purple)";
                    break;
                case 'crash_driver':
                    document.getElementById('driver').classList.add('crash');
                    document.getElementById('driver').innerText = "OOM ERROR";
                    break;
                case 'send_safe_driver':
                    [0,1,2,3].forEach(i => document.getElementById(`stage-${i}`).innerHTML = '');
                    document.getElementById('driver').style.boxShadow = "0 0 10px var(--neon-green)";
                    break;

                // CACHING
                case 'read_slow':
                    [0,1,2,3].forEach(i => {
                        document.getElementById(`stage-${i}`).innerHTML += `<div class="block slow">CSV</div>`;
                        updateRes(i, 30, 20);
                    });
                    break;
                case 'read_cache':
                    [0,1,2,3].forEach(i => {
                        document.getElementById(`stage-${i}`).innerHTML = `<div class="block cached">RAM</div>`;
                        updateRes(i, 60, 10, 'var(--neon-green)');
                    });
                    break;
                case 'read_ram':
                    // Flash the cached blocks
                    const blocks = document.querySelectorAll('.cached');
                    blocks.forEach(b => { b.style.background = '#fff'; setTimeout(()=>b.style.background='var(--neon-blue)', 200)});
                    break;

                // UDFs
                case 'proc_slow':
                    [0,1,2,3].forEach(i => {
                        document.getElementById(`stage-${i}`).innerHTML = `<div class="block slow">Py</div>`;
                        updateRes(i, 50, 90, 'var(--neon-orange)'); // High CPU
                    });
                    break;
                case 'proc_fast':
                    [0,1,2,3].forEach(i => {
                        document.getElementById(`stage-${i}`).innerHTML = `<div class="block salt">Arr</div>`;
                        updateRes(i, 40, 40, 'var(--neon-green)');
                    });
                    break;
            }
        }

        initScenario();
    </script>
</body>
</html>
