<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Logical Simulator</title>
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0f1115;
            --border: #27272a;
            --neon-blue: #00f3ff;
            --neon-green: #00ff9d;
            --neon-purple: #bc13fe;
            --neon-red: #ff0055;
            --text-main: #e0e6ed;
            --text-muted: #8b9bb4;
            --font-code: 'Consolas', monospace;
            --font-ui: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: var(--font-ui); height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }

        header { height: 60px; background: rgba(15,17,21,0.9); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--neon-green); letter-spacing: 1px; display: flex; gap: 15px; align-items: center; }
        
        .home-btn { text-decoration: none; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; border: 1px solid var(--border); padding: 6px 12px; border-radius: 4px; transition: 0.3s; display: flex; gap: 5px; }
        .home-btn:hover { border-color: var(--neon-blue); color: var(--neon-blue); background: rgba(0,243,255,0.1); }

        .grid-container { display: grid; grid-template-columns: 280px 1fr 400px; flex: 1; height: calc(100vh - 60px); }
        .panel { border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-dark); }
        .panel-header { padding: 12px; background: var(--bg-panel); border-bottom: 1px solid var(--border); font-size: 0.75rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; }

        /* CONTROLS */
        .controls { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        select { width: 100%; background: var(--bg-panel); color: white; border: 1px solid var(--border); padding: 10px; cursor: pointer; }
        .btn-run { width: 100%; padding: 12px; background: var(--neon-green); color: black; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-run:disabled { opacity: 0.5; cursor: not-allowed; }
        .log { flex: 1; background: #000; border: 1px solid var(--border); padding: 10px; font-family: var(--font-code); font-size: 0.8rem; overflow-y: auto; color: var(--text-muted); }
        
        /* CODE AREA */
        .sql-area { flex: 1; background: #080a0c; padding: 30px; font-family: var(--font-code); font-size: 1.1rem; line-height: 2; position: relative; }
        .sql-line { padding: 5px 10px; border-radius: 4px; transition: 0.3s; border-left: 3px solid transparent; opacity: 0.5; }
        .active-step { opacity: 1; background: rgba(0, 255, 157, 0.1); border-left-color: var(--neon-green); transform: translateX(10px); color: white; }
        .keyword { color: var(--neon-purple); font-weight: bold; }

        /* CUSTOM INPUT */
        #customInputArea {
            width: 100%; height: 100%; background: transparent; border: none; 
            color: var(--neon-blue); font-family: var(--font-code); font-size: 1.1rem; resize: none; outline: none;
            display: none;
        }
        #customInputArea::placeholder { color: #333; }

        /* VISUAL STAGE */
        .stage { flex: 1; background: radial-gradient(circle at center, #111 0%, #050505 100%); padding: 30px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        .data-table { border-collapse: collapse; min-width: 300px; background: var(--bg-panel); border: 1px solid var(--border); font-size: 0.85rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.5s; }
        .data-table th { background: #1a1e26; color: var(--neon-green); padding: 10px; text-align: left; }
        .data-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--text-main); transition: 0.3s; }
        
        .filtered-out { opacity: 0.2; text-decoration: line-through; color: var(--neon-red); }
        .kept { background: rgba(0, 255, 157, 0.1); }

        .db-info { font-size: 0.75rem; color: #555; margin-top: 10px; line-height: 1.4; }

    </style>
</head>
<body oncontextmenu="return false;">

    <header>
        <div class="brand">
            <a href="index.html" class="home-btn">üè† Home</a>
            <span>SQL LOGIC SIMULATOR</span>
        </div>
        <a href="#" onclick="alert('Step through SQL to see logical execution order.')" class="home-btn">Help ?</a>
    </header>

    <div class="grid-container">
        <!-- LEFT -->
        <div class="panel">
            <div class="panel-header">Controls</div>
            <div class="controls">
                <select id="simSelect" onchange="initSim()">
                    <option value="where">1. WHERE Filter</option>
                    <option value="join">2. Inner Join</option>
                    <option value="group">3. Group By</option>
                    <option value="custom" style="color: var(--neon-blue); font-weight:bold;">‚òÖ 4. Custom Query</option>
                </select>
                <button id="nextBtn" class="btn-run" onclick="nextStep()">‚ñ∂ Next Step</button>
                <div class="log" id="logger">Ready.</div>
                <div class="db-info" id="dbInfo">
                    <!-- DB Info injected via JS -->
                </div>
            </div>
        </div>

        <!-- CENTER -->
        <div class="panel">
            <div class="panel-header">SQL Code (Execution Order Highlight)</div>
            <div class="sql-area" id="codeEditorContainer">
                <div id="codeDisplay"></div>
                <textarea id="customInputArea" placeholder="SELECT * FROM employees WHERE salary > 50000"></textarea>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
            <div class="panel-header">Data Stage</div>
            <div class="stage" id="stage"></div>
        </div>
    </div>

    <script>
        // Security
        document.onkeydown = function(e) { if(e.keyCode == 123 || (e.ctrlKey && e.keyCode == 85)) return false; }

        // --- MOCK DATABASE ---
        const DB = {
            employees: [
                {id: 1, name: "Alice", role: "Dev", salary: 60000, dept_id: 101},
                {id: 2, name: "Bob", role: "Design", salary: 45000, dept_id: 102},
                {id: 3, name: "Charlie", role: "Lead", salary: 70000, dept_id: 101},
                {id: 4, name: "David", role: "Dev", salary: 55000, dept_id: 101},
                {id: 5, name: "Eve", role: "HR", salary: 48000, dept_id: 102}
            ],
            departments: [
                {id: 101, name: "Engineering"},
                {id: 102, name: "Human Resources"}
            ]
        };

        // --- PRESET SCENARIOS ---
        const scenarios = {
            where: {
                lines: [
                    { id: "sel", text: "SELECT name, role" },
                    { id: "frm", text: "FROM employees" },
                    { id: "whr", text: "WHERE salary > 50000" }
                ],
                steps: [
                    { line: "frm", msg: "1. FROM: Load Table 'employees'", action: "load", table: "employees" },
                    { line: "whr", msg: "2. WHERE: Filter Rows (salary > 50000)", action: "filter", condition: (r)=>r.salary > 50000 },
                    { line: "sel", msg: "3. SELECT: Pick Columns (name, role)", action: "select", cols: ["name", "role"] }
                ]
            },
            join: {
                lines: [
                    { id: "sel", text: "SELECT e.name, d.name" },
                    { id: "frm", text: "FROM employees e" },
                    { id: "join", text: "JOIN departments d ON e.dept_id = d.id" }
                ],
                steps: [
                    { line: "frm", msg: "1. FROM: Load Left Table", action: "load_left" },
                    { line: "join", msg: "2. JOIN: Match Keys", action: "show_join" },
                    { line: "sel", msg: "3. SELECT: Combine Columns", action: "show_result" }
                ]
            },
            group: {
                lines: [
                    { id: "sel", text: "SELECT dept_id, COUNT(*)" },
                    { id: "frm", text: "FROM employees" },
                    { id: "grp", text: "GROUP BY dept_id" }
                ],
                steps: [
                    { line: "frm", msg: "1. FROM: Load Data", action: "load_group" },
                    { line: "grp", msg: "2. GROUP BY: Bucket Rows by ID", action: "bucket" },
                    { line: "sel", msg: "3. SELECT: Aggregate Count", action: "agg" }
                ]
            }
        };

        // --- APP STATE ---
        let currentKey = 'where';
        let stepIdx = 0;
        let generatedSteps = []; // For custom query
        let generatedLines = []; // For custom query visualization

        // --- INITIALIZATION ---
        function initSim() {
            currentKey = document.getElementById('simSelect').value;
            stepIdx = 0;
            document.getElementById('logger').innerText = "Ready.";
            document.getElementById('stage').innerHTML = '<div style="color:#555; margin-top:50px;">Waiting...</div>';
            document.getElementById('dbInfo').innerHTML = `<strong>Available Tables:</strong><br>employees (id, name, role, salary, dept_id)<br>departments (id, name)`;

            const display = document.getElementById('codeDisplay');
            const customInput = document.getElementById('customInputArea');
            const runBtn = document.getElementById('nextBtn');

            if (currentKey === 'custom') {
                // Enable Custom Mode
                display.style.display = 'none';
                customInput.style.display = 'block';
                runBtn.innerText = "Parse & Run";
                runBtn.onclick = parseAndStartCustom;
                runBtn.disabled = false;
            } else {
                // Preset Mode
                display.style.display = 'block';
                customInput.style.display = 'none';
                runBtn.innerText = "‚ñ∂ Next Step";
                runBtn.onclick = nextStep;
                runBtn.disabled = false;

                // Render preset lines
                display.innerHTML = '';
                scenarios[currentKey].lines.forEach(l => {
                    display.innerHTML += `<div class="sql-line" id="${l.id}">${highlightSQL(l.text)}</div>`;
                });
            }
        }

        // --- CUSTOM PARSER LOGIC ---
        function parseAndStartCustom() {
            const rawSql = document.getElementById('customInputArea').value.trim();
            if(!rawSql) { alert("Please enter a SQL query."); return; }

            // 1. Basic Regex Parsing
            const fromMatch = rawSql.match(/FROM\s+(\w+)/i);
            const whereMatch = rawSql.match(/WHERE\s+(.+)/i);
            const selectMatch = rawSql.match(/SELECT\s+(.+?)(\s+FROM|$)/i);

            if(!fromMatch) { alert("Error: FROM clause is required."); return; }

            const tableName = fromMatch[1];
            if(!DB[tableName]) { alert(`Error: Table '${tableName}' does not exist.`); return; }

            // 2. Build Visualization DOM
            const display = document.getElementById('codeDisplay');
            const input = document.getElementById('customInputArea');
            
            input.style.display = 'none';
            display.style.display = 'block';
            display.innerHTML = '';

            generatedLines = [];
            generatedSteps = [];

            // 3. Generate Logical Plan
            // Step 1: FROM
            const lineIdFrom = "line_frm";
            generatedLines.push({id: lineIdFrom, text: `FROM ${tableName}`});
            generatedSteps.push({
                line: lineIdFrom, 
                msg: `1. FROM: Load table '${tableName}'`, 
                action: 'load', 
                table: tableName
            });

            // Step 2: WHERE (Optional)
            if(whereMatch) {
                const conditionStr = whereMatch[1];
                const lineIdWhere = "line_whr";
                generatedLines.push({id: lineIdWhere, text: `WHERE ${conditionStr}`});
                
                // Dangerous eval replacement for simulation purposes only
                // Convert SQL "salary > 50000" to JS "row.salary > 50000"
                const safeCondition = conditionStr.replace(/([a-zA-Z_]+)/g, "row.$1").replace(/=/g, "==").replace(/AND/gi, "&&").replace(/OR/gi, "||");
                
                try {
                    const predicate = new Function('row', `try { return ${safeCondition} } catch(e) { return false; }`);
                    generatedSteps.push({
                        line: lineIdWhere,
                        msg: `2. WHERE: Filter (${conditionStr})`,
                        action: 'filter',
                        condition: predicate
                    });
                } catch(e) {
                    console.error("Parse Error");
                }
            }

            // Step 3: SELECT
            const colsStr = selectMatch ? selectMatch[1] : "*";
            const lineIdSel = "line_sel";
            generatedLines.unshift({id: lineIdSel, text: `SELECT ${colsStr}`}); // Visual order: Select top
            generatedSteps.push({
                line: lineIdSel,
                msg: `3. SELECT: Project columns (${colsStr})`,
                action: 'select',
                cols: colsStr.includes('*') ? Object.keys(DB[tableName][0]) : colsStr.split(',').map(s=>s.trim())
            });

            // Render Generated Code
            generatedLines.forEach(l => {
                display.innerHTML += `<div class="sql-line" id="${l.id}">${highlightSQL(l.text)}</div>`;
            });

            // Reset State for Execution
            stepIdx = 0;
            currentKey = 'custom'; // Switch context
            document.getElementById('nextBtn').onclick = nextStep;
            document.getElementById('nextBtn').innerText = "‚ñ∂ Start Execution";
            document.getElementById('logger').innerHTML = "<div style='color:var(--neon-blue)'>Query Parsed Successfully.</div>";
        }

        // --- EXECUTION ENGINE ---
        function nextStep() {
            let s;
            if(currentKey === 'custom') {
                s = generatedSteps;
            } else {
                s = scenarios[currentKey].steps;
            }

            if(stepIdx >= s.length) return;
            
            const step = s[stepIdx];
            document.getElementById('logger').innerHTML += `<div>> ${step.msg}</div>`;
            
            document.querySelectorAll('.sql-line').forEach(el => el.classList.remove('active-step'));
            const activeLine = document.getElementById(step.line);
            if(activeLine) activeLine.classList.add('active-step');

            runVisual(step.action, step);

            stepIdx++;
            if(stepIdx >= s.length) {
                document.getElementById('nextBtn').innerText = "Done";
                document.getElementById('nextBtn').disabled = true;
            } else {
                document.getElementById('nextBtn').innerText = "‚ñ∂ Next Step";
            }
        }

        function runVisual(act, params) {
            const stage = document.getElementById('stage');
            
            // Common Actions
            if(act === 'load') {
                const data = DB[params.table];
                const cols = Object.keys(data[0]);
                stage.innerHTML = makeTable(data, cols);
                // Store data in DOM property for next steps
                stage.dataset.currentData = JSON.stringify(data);
            } 
            else if(act === 'filter') {
                const rows = stage.querySelectorAll('tbody tr');
                const data = JSON.parse(stage.dataset.currentData);
                
                data.forEach((row, index) => {
                    if(params.condition(row)) {
                        rows[index].classList.add('kept');
                    } else {
                        rows[index].classList.add('filtered-out');
                    }
                });
            } 
            else if(act === 'select') {
                // Simple visualization: clear table and show projected result
                // In a real filter scenario, we'd only take 'kept' rows.
                // For sim, we re-render simplistic logic based on previous data
                let data = JSON.parse(stage.dataset.currentData);
                
                // If we came from a filter step, apply filter again to get final dataset
                if(stepIdx > 0 && (currentKey === 'custom' || currentKey === 'where')) {
                     // Check if previous step was filter
                     // Hacky check for custom mode
                     if(currentKey === 'custom' && generatedSteps.length > 2) {
                         data = data.filter(params.condition || generatedSteps[1].condition); 
                     } else if (currentKey === 'where') {
                         data = data.filter(r => r.salary > 50000);
                     }
                }

                stage.innerHTML = makeTable(data, params.cols);
            } 
            
            // Preset Join Logic
            else if(act === 'load_left') {
                stage.innerHTML = makeTable(DB.employees.slice(0,3), ['id','name','dept_id']);
            } else if(act === 'show_join') {
                stage.innerHTML += `<div style="font-size:2rem; color:var(--neon-blue);">+</div>`;
                stage.innerHTML += makeTable(DB.departments, ['id','name']);
            } else if(act === 'show_result') {
                const res = [
                    {name: "Alice", dept: "Engineering"},
                    {name: "Bob", dept: "Human Resources"}
                ];
                stage.innerHTML = makeTable(res, ['name','dept']);
            }

            // Preset Group Logic
            else if(act === 'load_group') {
                stage.innerHTML = makeTable(DB.employees.slice(0,4), ['name','dept_id']);
            } else if(act === 'bucket') {
                stage.innerHTML = `
                    <div style="border:1px dashed #555; padding:10px; width:100%; margin-bottom:10px;">
                        <strong style="color:var(--neon-green)">Bucket 101</strong>
                        <div>Alice, Charlie, David</div>
                    </div>
                    <div style="border:1px dashed #555; padding:10px; width:100%;">
                        <strong style="color:var(--neon-green)">Bucket 102</strong>
                        <div>Bob</div>
                    </div>
                `;
            } else if(act === 'agg') {
                stage.innerHTML = makeTable([{dept_id:101, count:3}, {dept_id:102, count:1}], ['dept_id','count']);
            }
        }

        // Utils
        function makeTable(rows, keys) {
            if(rows.length === 0) return "<div>No Results</div>";
            
            // Handle SELECT * in custom mode
            let actualKeys = keys;
            if(keys[0] === '*') actualKeys = Object.keys(rows[0]);

            let h = `<table class="data-table"><thead><tr>${actualKeys.map(k=>`<th>${k}</th>`).join('')}</tr></thead><tbody>`;
            rows.forEach(r => {
                h += `<tr>${actualKeys.map(k=>`<td>${r[k] !== undefined ? r[k] : ''}</td>`).join('')}</tr>`;
            });
            return h + `</tbody></table>`;
        }

        function highlightSQL(text) {
            return text.replace(/(SELECT|FROM|WHERE|JOIN|ON|GROUP BY)/gi, '<span class="keyword">$1</span>');
        }

        initSim();
    </script>
</body>
</html>
